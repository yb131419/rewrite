<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å½¥å½¬ âœï¸æ–‡æ¡ˆæ”¹å¯«</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    body {
      font-family: 'Roboto', sans-serif;
      background: #121212;
      padding: 16px;
      margin: 0;
      color: #f0f0f0;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #1e1e1e;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 480px;
      padding: 20px;
      box-sizing: border-box;
    }
    h2 {
      margin-bottom: 16px;
      color: #ffffff;
      font-weight: 700;
      font-size: 20px;
    }
    textarea, select {
      width: 100%;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #2a2a2a;
      border: 1px solid #3f3f3f;
      color: #f0f0f0;
      font-size: 15px;
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      box-sizing: border-box;
    }
    textarea:focus, select:focus {
      outline: none;
      border-color: #4dabf7;
    }
    textarea {
      height: 120px;
      resize: vertical;
    }
    label {
      margin-top: 20px;
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: #cccccc;
    }
    button {
      margin-top: 20px;
      background: linear-gradient(135deg, #4dabf7, #2d9cdb);
      border: none;
      color: white;
      font-weight: bold;
      font-size: 16px;
      padding: 13px 0;
      width: 100%;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #339af0, #228be6);
    }
    #rewriteResult {
      margin-top: 24px;
      background: #232323;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #373737;
      color: #e0e0e0;
      font-size: 14.5px;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    #rewriteResult b {
      display: block;
      margin-top: 12px;
      color: #74c0fc;
      font-weight: 600;
      font-size: 15px;
    }
    .rewrite-text p {
      margin: 10px 0;
      line-height: 1.8;
    }
    .error {
      background: #3c1e1e;
      border: 1px solid #d93025;
      padding: 14px;
      color: #ff6b6b;
      font-weight: bold;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .action-buttons button {
      flex: 1;
      background: #333;
      border: 1px solid #555;
      font-size: 14px;
      padding: 10px;
    }
    @media (min-width: 600px) {
      .card { padding: 24px; }
      h2 { font-size: 22px; }
      button { font-size: 17px; }
      #rewriteResult { font-size: 15.5px; }
    }
    #bigAlert {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(50, 50, 50, 0.9);
      color: #4CAF50;
      font-size: 40px;
      font-weight: 700;
      padding: 20px 40px;
      border-radius: 20px;
      box-shadow: 0 0 15px #4CAF50;
      z-index: 9999;
      display: none;
      user-select: none;
      text-align: center;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="card" role="main">
    <h2>ğŸ“˜ å½¥å½¬æ–‡æ¡ˆæ”¹å¯«ã€è²¼ä¸Šæ–‡ç« è‡ªå‹•æ”¹å¯«</h2>
    <textarea id="originalText" placeholder="è«‹è²¼ä¸ŠåŸå§‹æ–‡ç« ..." aria-label="åŸå§‹æ–‡ç« å…§å®¹"></textarea>

    <label for="topicSelect">é¸æ“‡åˆ†é¡ä¸»é¡Œï¼ˆå¯AIè‡ªå‹•åˆ¤æ–·ï¼‰ï¼š</label>
    <select id="topicSelect" name="topicSelect" aria-label="åˆ†é¡ä¸»é¡Œé¸æ“‡">
      <option value="">AI è‡ªå‹•åˆ¤æ–·</option>
      <option>äººç”Ÿæˆé•·</option>
      <option>æƒ…æ„Ÿæ•…äº‹</option>
      <option>å•†æ¥­æ´å¯Ÿ</option>
      <option>ç§‘æŠ€æœªä¾†</option>
      <option>å“ç‰Œè¡ŒéŠ·</option>
    </select>

    <label for="lengthSelect">é¸æ“‡æ”¹å¯«é•·åº¦ï¼š</label>
    <select id="lengthSelect" name="lengthSelect" aria-label="æ”¹å¯«é•·åº¦é¸æ“‡">
      <option value="short" selected>çŸ­æ•…äº‹ï¼ˆç´„95ï½115å­—ï¼‰</option>
      <option value="long">é•·æ•…äº‹ï¼ˆç´„165ï½180å­—ï¼‰</option>
    </select>

    <button id="rewriteBtn" onclick="autoRewrite()">ğŸš€ è‡ªå‹•æ”¹å¯«</button>

    <div id="rewriteResult" aria-live="polite" aria-atomic="true"></div>

    <div class="action-buttons" style="display:none;" id="afterButtons">
      <button onclick="copyResult()">ğŸ“‹ è¤‡è£½å…§å®¹</button>
      <button onclick="shareToLine()">ğŸ“¤ åˆ†äº«å…§å®¹</button>
      <button onclick="generateImageAndOpen()">ğŸ–¼ï¸ æ–‡æ¡ˆè½‰åœ–ç‰‡</button>
    </div>
  </div>

  <div id="bigAlert" role="alert" aria-live="assertive"></div>

  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.min.js" onload="initLiff()"></script>

<script>
  let isInLine = false;
  let resultText = '';
  let debounceTimer = null;

  // åˆå§‹åŒ– LIFF
  function initLiff() {
    liff.init({ liffId: "2007475335-63jZvMxQ" })
      .then(() => {
        isInLine = liff.isInClient();
        setupEventListeners();
      })
      .catch(err => {
        console.warn("LIFF åˆå§‹åŒ–å¤±æ•—", err);
      });
  }

  // ç¶å®šäº‹ä»¶ç›£è½å™¨
  function setupEventListeners() {
    const textarea = document.getElementById('originalText');
    textarea.addEventListener('input', () => {
      if (textarea.value.trim()) debounceAutoRewrite();
    });

    document.getElementById('topicSelect').addEventListener('change', () => {
      if (textarea.value.trim()) autoRewrite();
    });

    document.getElementById('lengthSelect').addEventListener('change', () => {
      if (textarea.value.trim()) autoRewrite();
    });
  }

  // é˜²æŠ–å‹•è‡ªå‹•æ”¹å¯«
  function debounceAutoRewrite() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      autoRewrite();
    }, 1000);
  }

  // å…§å®¹è½‰æˆæœ‰æ®µè½ <p> æ¨™ç±¤
  function formatContentWithParagraphs(content) {
    if (typeof content !== 'string' || !content.trim()) return '';
    const paragraphs = content.split(/\n\n|\n|(?<=ã€‚)/).map(p => p.trim()).filter(Boolean);
    return paragraphs.map(p => `<p>${p}</p>`).join('');
  }

  // åŸ·è¡Œæ”¹å¯«ä¸»ç¨‹å¼
  function autoRewrite() {
    const text = document.getElementById("originalText").value.trim();
    const topic = document.getElementById("topicSelect").value;
    const length = document.getElementById("lengthSelect").value;
    const resultDiv = document.getElementById("rewriteResult");
    const btn = document.getElementById("rewriteBtn");

    if (!text) {
      alert("è«‹å…ˆè²¼ä¸Šæ–‡ç« å…§å®¹");
      return;
    }

    btn.disabled = true;
    btn.textContent = "âœï¸ æ”¹å¯«ä¸­...";
    resultDiv.innerHTML = "â³ æ”¹å¯«ä¸­ï¼Œè«‹ç¨å€™...";
    document.getElementById("afterButtons").style.display = "none";

    // å‘¼å« Google Apps Script å¾Œç«¯
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false;
          btn.textContent = "ğŸš€ è‡ªå‹•æ”¹å¯«";

          if (!res || typeof res !== 'object') {
            resultDiv.innerHTML = `<div class="error">âŒ å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤</div>`;
            return;
          }

          if (res.error) {
            resultDiv.innerHTML = `<div class="error">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${res.error}</div>`;
            return;
          }

          if (!res.content || typeof res.content !== 'string') {
            resultDiv.innerHTML = `<div class="error">âŒ æ”¹å¯«å…§å®¹ä¸å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤</div>`;
            return;
          }

          const formattedContent = formatContentWithParagraphs(res.content);

          resultText = `ğŸ“Œ æ¨™é¡Œï¼š\n${res.title || ''}\n\nğŸ“‚ åˆ†é¡ï¼š\n${res.topic || ''}\n\nğŸ“ æ”¹å¯«å…§å®¹ï¼š\n${res.content}`;

          resultDiv.innerHTML = `
            <b>ğŸ”– é¡åˆ¥ï¼š</b>${res.topic || ''}
            <b class="recommend-title-text">ğŸ“Œ æ¨è–¦æ¨™é¡Œï¼š</b>${res.title || ''}
            <b>ğŸ“ æ”¹å¯«å…§å®¹ï¼š</b>
            <div class="rewrite-text">${formattedContent}</div>
          `;

          document.getElementById("afterButtons").style.display = "flex";

          // ç´€éŒ„æ”¹å¯«æ­·å²
          google.script.run.recordRewriteHistory({
            text,
            topic,
            length,
            title: res.title,
            content: res.content
          });
        })
        .withFailureHandler(err => {
          btn.disabled = false;
          btn.textContent = "ğŸš€ è‡ªå‹•æ”¹å¯«";
          resultDiv.innerHTML = `<div class="error">âŒ å‘¼å«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>`;
          console.error(err);
        })
        .rewriteWithAI(text, topic, length);
    } else {
      btn.disabled = false;
      btn.textContent = "ğŸš€ è‡ªå‹•æ”¹å¯«";
      resultDiv.innerHTML = `<div class="error">âŒ ç„¡æ³•å‘¼å« Google Apps Scriptï¼Œè«‹åœ¨ Apps Script ç’°å¢ƒä¸­åŸ·è¡Œ</div>`;
    }
  }

  // è¤‡è£½çµæœæ–‡å­—
  function copyResult() {
    if (!resultText) return;
    navigator.clipboard.writeText(resultText)
      .then(() => showBigAlert("âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"))
      .catch(() => alert("âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"));
  }

  // åˆ†äº«å…§å®¹åˆ° LINE æˆ–åŸç”Ÿåˆ†äº«
  function shareToLine() {
    const titleElem = document.querySelector(".recommend-title-text");
    const title = titleElem ? titleElem.nextSibling.textContent.trim() : "æ”¹å¯«å…§å®¹";
    const contentDiv = document.querySelector(".rewrite-text");
    let content = "";

    if (contentDiv) {
      content = Array.from(contentDiv.querySelectorAll('p'))
        .map(p => p.textContent.trim())
        .filter(Boolean)
        .join('\n\n');
    }

    const message = `ğŸ“Œ æ¨è–¦æ¨™é¡Œï¼š\n\n${title}\n\nğŸ“ æ”¹å¯«å…§å®¹ï¼š\n\n${content}`;

    if (isInLine && liff.isApiAvailable('shareTargetPicker')) {
      liff.shareTargetPicker([{ type: "text", text: message }])
        .then(() => showBigAlert("âœ… å·²åˆ†äº«ï¼"))
        .catch(err => {
          console.error("âŒ LINE åˆ†äº«å¤±æ•—", err);
          alert("âŒ åˆ†äº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        });
    } else if (navigator.share) {
      navigator.share({ title, text: message })
        .then(() => showBigAlert("âœ… å·²åˆ†äº«ï¼"))
        .catch(err => {
          console.error("âŒ åŸç”Ÿåˆ†äº«å¤±æ•—", err);
          alert("âŒ åˆ†äº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        });
    } else {
      alert("âŒ ç„¡æ³•åˆ†äº«ï¼Œè«‹ç”¨ LINE App æˆ–æ‰‹æ©Ÿç€è¦½å™¨é–‹å•Ÿ");
    }
  }

  // å°‡æ–‡å­—ç”¢ç”Ÿåœ–ç‰‡ä¸¦é–‹å•Ÿæ–°è¦–çª—
  function generateImageAndOpen() {
    if (!resultText) return;

    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run.withSuccessHandler(url => {
        if (url && typeof url === 'string') {
          window.open(url, '_blank');
        } else {
          alert("âŒ åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—");
        }
      }).generateImageFromText(resultText);
    } else {
      alert("âŒ ç„¡æ³•å‘¼å« Google Apps Scriptï¼Œè«‹åœ¨ Apps Script ç’°å¢ƒä¸­åŸ·è¡Œ");
    }
  }

  // é¡¯ç¤ºä¸­å¤®å¤§æç¤ºè¨Šæ¯
  function showBigAlert(message) {
    const alertDiv = document.getElementById('bigAlert');
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';

    clearTimeout(alertDiv._timeout);
    alertDiv._timeout = setTimeout(() => {
      alertDiv.style.display = 'none';
    }, 2000);
  }
</script>


</body>
</html>
